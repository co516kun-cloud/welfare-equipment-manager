<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ©ãƒ™ãƒ«å°åˆ· - Brother QL-800</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Yu Gothic", "Meiryo", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      padding: 30px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .queue-list {
      margin-top: 20px;
    }

    .queue-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .queue-item-info {
      flex: 1;
    }

    .queue-item-info h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 5px;
    }

    .queue-item-info p {
      color: #666;
      font-size: 14px;
      margin: 3px 0;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .actions {
      text-align: center;
      margin-top: 20px;
    }

    .actions .btn {
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ·ï¸ ãƒ©ãƒ™ãƒ«å°åˆ·</h1>
    <p class="subtitle">Brother QL-800 ãƒ©ãƒ™ãƒ«ãƒ—ãƒªãƒ³ã‚¿ãƒ¼</p>

    <div id="status" class="status info">
      åˆæœŸåŒ–ä¸­...
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>å°åˆ·å¾…ã¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <div id="queueList" class="queue-list" style="display: none;"></div>

    <div id="debugLog" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none;">
      <div style="margin-bottom: 10px; font-weight: bold;">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°:</div>
      <div id="debugContent"></div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" onclick="window.location.reload()">ğŸ”„ æ›´æ–°</button>
      <button class="btn btn-danger" onclick="window.close()">âœ–ï¸ é–‰ã˜ã‚‹</button>
      <button class="btn btn-primary" onclick="toggleDebugLog()">ğŸ› ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</button>
    </div>
  </div>

  <script>
    // Supabaseè¨­å®šï¼ˆ.envã‹ã‚‰èª­ã¿è¾¼ã‚ãªã„ãŸã‚ã€ç›´æ¥è¨­å®šãŒå¿…è¦ï¼‰
    // æœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‹ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å‡¦ç†ã—ã¦ãã ã•ã„
    var SUPABASE_URL = 'https://xbltuzyazsafxbacrzfs.supabase.co'; // ã“ã“ã«å®Ÿéš›ã®URLã‚’è¨­å®š
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhibHR1enlhenNhZnhiYWNyemZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjU5NjMsImV4cCI6MjA2ODkwMTk2M30.RwlAsXQ_sj9k9-5Zxs3aP0pC3seKOVe-NVVi-ioSykw'; // ã“ã“ã«å®Ÿéš›ã®ã‚­ãƒ¼ã‚’è¨­å®š
    var TEMPLATE_PATH = 'C:\\Users\\taguchi\\Desktop\\claude-kanri\\welfare-equipment-manager\\public\\templates\\equipment-label.lbx';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var queueData = [];
    var statusDiv = document.getElementById('status');
    var loadingDiv = document.getElementById('loading');
    var queueListDiv = document.getElementById('queueList');
    var debugLogDiv = document.getElementById('debugLog');
    var debugContentDiv = document.getElementById('debugContent');
    var debugMessages = [];

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¡¨ç¤º/éè¡¨ç¤º
    function toggleDebugLog() {
      if (debugLogDiv.style.display === 'none') {
        debugLogDiv.style.display = 'block';
      } else {
        debugLogDiv.style.display = 'none';
      }
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ç”»é¢ã®ä¸¡æ–¹ã«å‡ºåŠ›ï¼‰
    function debugLog(message) {
      console.log(message);
      var timestamp = new Date().toLocaleTimeString();
      var logEntry = '[' + timestamp + '] ' + message;
      debugMessages.push(logEntry);
      if (debugContentDiv) {
        debugContentDiv.innerHTML = debugMessages.join('<br>');
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(message, type) {
      statusDiv.className = 'status ' + type;
      statusDiv.textContent = message;
    }

    // b-PAC SDK ãƒã‚§ãƒƒã‚¯
    function checkBPacAvailable() {
      debugLog('=== b-PAC SDK ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');
      debugLog('typeof ActiveXObject: ' + typeof ActiveXObject);
      debugLog('ActiveXObject in window: ' + ('ActiveXObject' in window));
      debugLog('User Agent: ' + navigator.userAgent);

      try {
        debugLog('ActiveXObject("bpac.Document") ä½œæˆã‚’è©¦è¡Œ...');
        var testObj = new ActiveXObject('bpac.Document');
        debugLog('âœ… b-PAC SDK æ¤œå‡ºæˆåŠŸ');
        debugLog('testObj ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸ');
        return true;
      } catch (e) {
        debugLog('âŒ b-PAC SDK æ¤œå‡ºå¤±æ•—');
        debugLog('ã‚¨ãƒ©ãƒ¼å: ' + e.name);
        debugLog('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + e.message);
        debugLog('32bitç‰ˆ b-PAC SDK ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        return false;
      }
    }

    // Supabaseã‹ã‚‰å°åˆ·å¾…ã¡ãƒ‡ãƒ¼ã‚¿å–å¾—
    function loadPrintQueue() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', SUPABASE_URL + '/rest/v1/label_print_queue?status=eq.pending&order=created_at.desc', true);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
      xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_ANON_KEY);

      xhr.onload = function() {
        loadingDiv.style.display = 'none';

        if (xhr.status === 200) {
          queueData = JSON.parse(xhr.responseText);

          if (queueData.length === 0) {
            showStatus('âœ… å°åˆ·å¾…ã¡ã¯ã‚ã‚Šã¾ã›ã‚“', 'success');
          } else {
            showStatus('ğŸ“‹ å°åˆ·å¾…ã¡: ' + queueData.length + 'ä»¶', 'info');
            renderQueue();
          }
        } else {
          showStatus('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + xhr.status, 'error');
        }
      };

      xhr.onerror = function() {
        loadingDiv.style.display = 'none';
        showStatus('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
      };

      xhr.send();
    }

    // ã‚­ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderQueue() {
      queueListDiv.style.display = 'block';
      queueListDiv.innerHTML = '';

      for (var i = 0; i < queueData.length; i++) {
        var item = queueData[i];
        var div = document.createElement('div');
        div.className = 'queue-item';
        div.innerHTML =
          '<div class="queue-item-info">' +
            '<h3>' + item.product_name + '</h3>' +
            '<p>ç®¡ç†ç•ªå·: <strong>' + item.management_id + '</strong></p>' +
            '<p>çŠ¶æ…‹: ' + (item.condition_notes || '(ãƒ¡ãƒ¢ãªã—)') + '</p>' +
            '<p>ç™»éŒ²è€…: ' + item.created_by + '</p>' +
          '</div>' +
          '<button class="btn btn-success" onclick="printLabel(\'' + item.id + '\')">ğŸ–¨ï¸ å°åˆ·</button>';

        queueListDiv.appendChild(div);
      }
    }

    // ãƒ©ãƒ™ãƒ«å°åˆ·å®Ÿè¡Œ
    function printLabel(queueId) {
      if (!checkBPacAvailable()) {
        alert('âŒ b-PAC SDKãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã€‚\nBrother b-PAC3 SDKã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ã‚­ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢
      var queueItem = null;
      for (var i = 0; i < queueData.length; i++) {
        if (queueData[i].id === queueId) {
          queueItem = queueData[i];
          break;
        }
      }

      if (!queueItem) {
        alert('âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        showStatus('ğŸ–¨ï¸ å°åˆ·ä¸­: ' + queueItem.management_id, 'warning');
        debugLog('=== å°åˆ·å‡¦ç†é–‹å§‹ ===');
        debugLog('ç®¡ç†ç•ªå·: ' + queueItem.management_id);
        debugLog('å•†å“å: ' + queueItem.product_name);
        debugLog('çŠ¶æ…‹ãƒ¡ãƒ¢: ' + queueItem.condition_notes);
        debugLog('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ã‚¹: ' + TEMPLATE_PATH);

        // b-PAC Document ä½œæˆ
        debugLog('ActiveXObject("bpac.Document") ä½œæˆ...');
        var objDoc = new ActiveXObject('bpac.Document');
        debugLog('objDoc ä½œæˆæˆåŠŸï¼ˆCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰');

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–‹ã
        debugLog('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é–‹ã...');
        var ret = objDoc.Open(TEMPLATE_PATH);
        debugLog('Open() æˆ»ã‚Šå€¤: ' + ret);
        debugLog('objDoc.ErrorCode: ' + objDoc.ErrorCode);

        if (!ret) {
          var errorCode = objDoc.ErrorCode;
          throw new Error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é–‹ã‘ã¾ã›ã‚“: ' + TEMPLATE_PATH + ' (ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + errorCode + ')');
        }

        debugLog('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–‹ã„ãŸ');

        // ãƒ‡ãƒ¼ã‚¿è¨­å®š
        debugLog('ãƒ‡ãƒ¼ã‚¿è¨­å®šé–‹å§‹...');
        try {
          var mgmtObj = objDoc.GetObject('ManagementID');
          debugLog('ManagementID ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—: ' + (mgmtObj ? 'OK' : 'null'));
          if (mgmtObj) mgmtObj.Text = queueItem.management_id;

          var nameObj = objDoc.GetObject('ProductName');
          debugLog('ProductName ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—: ' + (nameObj ? 'OK' : 'null'));
          if (nameObj) nameObj.Text = queueItem.product_name;

          var condObj = objDoc.GetObject('ConditionNotes');
          debugLog('ConditionNotes ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—: ' + (condObj ? 'OK' : 'null'));
          if (condObj) condObj.Text = queueItem.condition_notes || '';

          var qrObj = objDoc.GetObject('QRCode');
          debugLog('QRCode ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—: ' + (qrObj ? 'OK' : 'null'));
          if (qrObj) qrObj.Text = queueItem.management_id;

          debugLog('âœ… ãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº†');
        } catch (e) {
          debugLog('ãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
          throw new Error('ãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
        }

        // objDoc ã®ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ - é‹ç”¨æ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¯ï¼‰
        // debugLog('=== objDoc ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª ===');
        // try {
        //   debugLog('objDoc.Print: ' + typeof objDoc.Print);
        //   debugLog('objDoc.PrintOut: ' + typeof objDoc.PrintOut);
        //   debugLog('objDoc.DoPrint: ' + typeof objDoc.DoPrint);
        //   debugLog('objDoc.StartPrint: ' + typeof objDoc.StartPrint);
        //   debugLog('objDoc.Export: ' + typeof objDoc.Export);
        // } catch (e) {
        //   debugLog('ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + e.message);
        // }

        // å°åˆ·å®Ÿè¡Œ
        debugLog('=== å°åˆ·å®Ÿè¡Œ ===');
        var printResult = false;

        // æ–¹æ³•1: StartPrint + PrintOut + EndPrintï¼ˆæ¨å¥¨ãƒ•ãƒ­ãƒ¼ï¼‰
        try {
          debugLog('æ–¹æ³•1: StartPrint + PrintOut + EndPrint ã‚’è©¦è¡Œ...');

          // StartPrint ã§å°åˆ·ã‚¸ãƒ§ãƒ–é–‹å§‹
          if (typeof objDoc.StartPrint !== 'undefined') {
            debugLog('objDoc.StartPrint() ã‚’å®Ÿè¡Œ...');
            var startResult = objDoc.StartPrint('', 0);
            debugLog('StartPrint() æˆ»ã‚Šå€¤: ' + startResult);
          }

          // PrintOut ã§å°åˆ·
          debugLog('objDoc.PrintOut(1, 0) ã‚’å®Ÿè¡Œ...');
          printResult = objDoc.PrintOut(1, 0);
          debugLog('PrintOut() æˆ»ã‚Šå€¤: ' + printResult);
          debugLog('objDoc.ErrorCode: ' + objDoc.ErrorCode);

          // EndPrint ã§å°åˆ·ã‚¸ãƒ§ãƒ–çµ‚äº†
          if (typeof objDoc.EndPrint !== 'undefined') {
            debugLog('objDoc.EndPrint() ã‚’å®Ÿè¡Œ...');
            objDoc.EndPrint();
            debugLog('EndPrint() å®Œäº†');
          }

          debugLog('âœ… æ–¹æ³•1æˆåŠŸ');
        } catch (e1) {
          debugLog('âŒ æ–¹æ³•1å¤±æ•—: ' + e1.message);

          // æ–¹æ³•2: DoPrintï¼ˆä¸€æ‹¬å‡¦ç†ï¼‰
          try {
            debugLog('æ–¹æ³•2: objDoc.DoPrint() ã‚’è©¦è¡Œ...');
            printResult = objDoc.DoPrint();
            debugLog('âœ… æ–¹æ³•2æˆåŠŸ - DoPrint() æˆ»ã‚Šå€¤: ' + printResult);
          } catch (e2) {
            debugLog('âŒ æ–¹æ³•2å¤±æ•—: ' + e2.message);

            // æ–¹æ³•3: Export ã—ã¦ã‹ã‚‰å°åˆ·
            try {
              debugLog('æ–¹æ³•3: Export + PrintOut ã‚’è©¦è¡Œ...');

              // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
              var tempPath = 'C:\\temp\\label_temp.prn';
              debugLog('Export() å®Ÿè¡Œä¸­...');
              var exportResult = objDoc.Export(3, tempPath, 0); // 3 = ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
              debugLog('Export() æˆ»ã‚Šå€¤: ' + exportResult);

              if (exportResult) {
                debugLog('PrintOut() å®Ÿè¡Œä¸­...');
                printResult = objDoc.PrintOut(1, 0);
                debugLog('PrintOut() æˆ»ã‚Šå€¤: ' + printResult);
              }

              debugLog('âœ… æ–¹æ³•3æˆåŠŸ');
            } catch (e3) {
              debugLog('âŒ æ–¹æ³•3å¤±æ•—: ' + e3.message);
              throw new Error('å…¨ã¦ã®å°åˆ·ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ');
            }
          }
        }

        objDoc.Close();
        debugLog('âœ… å°åˆ·å‡¦ç†å®Œäº†');

        if (printResult) {
          // æˆåŠŸ: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ completed ã«æ›´æ–°
          updateQueueStatus(queueId, 'completed', function() {
            showStatus('âœ… å°åˆ·å®Œäº†: ' + queueItem.management_id, 'success');
            setTimeout(function() {
              window.location.reload();
            }, 2000);
          });
        } else {
          throw new Error('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        debugLog('âŒ å°åˆ·å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
        showStatus('âŒ å°åˆ·ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');

        // å¤±æ•—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ failed ã«æ›´æ–°
        updateQueueStatus(queueId, 'failed', null, error.message);
      }
    }

    // ã‚­ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateQueueStatus(queueId, status, callback, errorMessage) {
      var xhr = new XMLHttpRequest();
      xhr.open('PATCH', SUPABASE_URL + '/rest/v1/label_print_queue?id=eq.' + queueId, true);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
      xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_ANON_KEY);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Prefer', 'return=minimal');

      var updateData = {
        status: status,
        updated_at: new Date().toISOString()
      };

      if (status === 'completed') {
        updateData.printed_at = new Date().toISOString();
        updateData.printed_by = 'IEå°åˆ·ãƒšãƒ¼ã‚¸';
      }

      if (status === 'failed' && errorMessage) {
        updateData.error_message = errorMessage;
      }

      xhr.onload = function() {
        if (xhr.status === 204 && callback) {
          callback();
        }
      };

      xhr.send(JSON.stringify(updateData));
    }

    // åˆæœŸåŒ–
    window.onload = function() {
      // ActiveXObjectã®å­˜åœ¨ç¢ºèª
      var hasActiveX = typeof ActiveXObject !== 'undefined' || 'ActiveXObject' in window;

      console.log('=== åˆæœŸåŒ–é–‹å§‹ ===');
      console.log('ActiveXObjectåˆ©ç”¨å¯èƒ½:', hasActiveX);

      if (!hasActiveX) {
        showStatus('âš ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã¯IEãƒ¢ãƒ¼ãƒ‰ã§é–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        loadingDiv.innerHTML =
          '<div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 20px; border-radius: 8px; color: #856404;">' +
          '<p style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">ğŸ”„ IEãƒ¢ãƒ¼ãƒ‰ã§å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>' +
          '<ol style="text-align: left; margin: 10px 0; padding-left: 20px;">' +
          '<li>ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ <strong>...</strong>ï¼ˆãã®ä»–ï¼‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯</li>' +
          '<li><strong>ã€Œãã®ä»–ã®ãƒ„ãƒ¼ãƒ«ã€</strong> â†’ <strong>ã€ŒInternet Explorer ãƒ¢ãƒ¼ãƒ‰ã§å†èª­ã¿è¾¼ã¿ã€</strong> ã‚’é¸æŠ</li>' +
          '<li>ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™</li>' +
          '</ol>' +
          '<p style="margin-top: 15px; font-size: 14px;">ğŸ’¡ ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«ã€ŒIEã€ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°IEãƒ¢ãƒ¼ãƒ‰ã§ã™</p>' +
          '</div>';
        return;
      }

      // b-PAC SDK ãƒã‚§ãƒƒã‚¯
      if (!checkBPacAvailable()) {
        showStatus('âŒ b-PAC SDKãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“', 'error');
        loadingDiv.innerHTML =
          '<div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; color: #721c24;">' +
          '<p style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">Brother b-PAC3 SDKãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>' +
          '<p>ã“ã®ãƒšãƒ¼ã‚¸ã§å°åˆ·ã™ã‚‹ã«ã¯ã€Brother b-PAC3 SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚</p>' +
          '<p style="margin-top: 10px;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€: <code>C:\\Program Files (x86)\\Brother\\Brother bPAC3 SDK\\</code></p>' +
          '<p style="margin-top: 10px; font-size: 14px;">F12ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¿ãƒ–ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>' +
          '</div>';
        return;
      }

      showStatus('âœ… b-PAC SDK æ¤œå‡ºæ¸ˆã¿', 'success');

      // Supabaseè¨­å®šãƒã‚§ãƒƒã‚¯
      if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        showStatus('âš ï¸ Supabaseè¨­å®šãŒå¿…è¦ã§ã™', 'warning');
        loadingDiv.innerHTML =
          '<p style="color: #856404; font-weight: bold;">ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«Supabaseæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>' +
          '<p>SUPABASE_URL ã¨ SUPABASE_ANON_KEY ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</p>';
        return;
      }

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadPrintQueue();
    };
  </script>
</body>
</html>
